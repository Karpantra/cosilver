
<div class="container">
  <div class="map-container text-center col-xs-12 col-sm-6 ">

    <h3 id="services-main-title">Trouvez un service sur mesure</h3>

    <%= form_tag(services_path, method: :get, class: 'form-search') do %>
    <%= text_field_tag :search_city, params[:search_city] , placeholder: "ville", class: "input-medium search-query" %>
    <br>
    <br>
    <%= select_tag :search_category, options_for_select(Service::SOUS_CATEGORIES, params[:search_category]), prompt: "Catégorie" %>
    <br>
    <br>

    <%= submit_tag "Trouvez un spécialiste", class: "btn btn-primary" %>
    <% end %>


    <div class="mappy">
      <div class="card">
        <div id="map" style="width: 100%; height: 100vh;"></div>
      </div>
    </div>
  </div>

  <div class="container-index col-xs-12 col-sm-6" style="overflow:scroll; height: 94 vh;">

   <% @services.each do |service| %>
   <div class="card white">
     <div class="card-link">



      <%#= link_to " ", service_path(service), class: "card-link" %>

      <h4 class= "text-center" ><%= service.title.first(45) %></h4>
      <div class="col-sm-6">
        <% if service.provider.photos.first.nil? %>
        <%= image_tag "cosilverlogo#{rand(1..3)}.png", width: 100, height: 100, crop: :fill, radius: 100 %>
        <% else %>
        <%= cl_image_tag service.provider.photos.first.path, width: 100, height: 100, crop: :fill, radius: 100 %>
        <% end %>
        <br>

      </div>

      <div class="col-sm-6">
        <span> <i class="fa fa-flag" aria-hidden="true"></i> &nbsp <%= service.category.first(22) %>...</span>
        <br>

        <span> <i class="fa fa-map-marker" aria-hidden="true"></i> &nbsp &nbsp   <%= service.address %></span>
        <br>
        <span> <i class="fa fa-money" aria-hidden="true"></i> &nbsp   <%= service.price_per_hour %>
         € </span>
         <br>

         <%#= link_to "Réserver une prestation", service_path(service),   class: "btn btn-success float-left" %>

         <%#= link_to "Réserver une prestation", "#", data: {toggle: "modal", target: "#myservice_path#{service.id}" }%>
         <%= link_to "réserver un créneau", "#", data: {toggle: "modal", target: "#service_path#{service.id}" }, class:"btn btn-primary float-left btn-modal", id:"#{service.id}"%>

       </div>
     </div>
   </div>
   <% end %>
 </div>
</div>

<% @services.each do |service| %>
  <div class="modal modalbox fade" id="service_path<%= service.id %>" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content ">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body text-center modal-resize">
          <h4 class="modal-title" id="myModalLabel"> <%= service.title %> </h4>
          <div class="container text-center">
            <div class="col-xs-12 col-sm-2">
              <% if service.provider.photos.first.nil? %>
                <%= image_tag "prestataire.png", width: 100, height: 100, crop: :fill, radius: 100 %>
              <% else %>
                <%= cl_image_tag service.provider.photos.first.path, width: 100, height: 100, crop: :fill, radius: 100%>
              <% end %>
              <p><%= service.description %></p>
              <h4> <%= service.provider.first_name %></h4>
              <h5> <%= service.title %></h5>
              <p><i class="fa fa-map-marker" aria-hidden="true"></i> <%= service.address.last(5) %></p>
              <h5>
               <i class="fa fa-money" aria-hidden="true"></i> <span> <%= service.price_per_hour %> €/heure</span></h5>
              </div>
              <div class="col-xs-12 col-sm-4">
                <div class="padded ">
                <%= simple_form_for service do |f| %>
                  <div class="form-group">
                    <label for="" class="control-label">Sélectionnez vos disponibilités</label>
                    <% @availabilities["avail-#{service.id}"] = service.availabilities.where(available: true).pluck(:date).map { | date| date.strftime("%-d-%-m-%Y") } %>
                    <div  class="datepicker-show"></div>
                    <input type="hidden" class="my_hidden_input_show" name="booking_dates">
                  </div>
                  <%= f.submit "Réservez une prestation", class: "btn btn-success" %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% content_for(:after_js) do %>
  <script>
    $(document).ready(function() {
      var handler = Gmaps.build('Google');
      handler.buildMap({ internal: { id: 'map' } }, function() {
        markers = handler.addMarkers(<%= raw @hash.to_json %>);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
        if (markers.length == 0) {
          handler.getMap().setZoom(2);
        } else if (markers.length == 1) {
          handler.getMap().setZoom(14);
        }
      });
    });

    $('.btn-modal').click(function(){
      var service_id = parseInt($(this).attr('id'));
      var availabilities = <%= raw @availabilities.to_json %>

      var availableDates = availabilities["avail-" + service_id]

      console.log(availableDates);
      $('.datepicker-show').datepicker("destroy");
      $('.datepicker-show').datepicker({
        format: "dd/mm/yyyy",
        weekStart: 1,
        multidate: true,
        beforeShowDay:
        function(date)
        {
          return available(date)
        }
      });

      $('.datepicker-show').on('changeDate', function() {
        $(this).siblings(".my_hidden_input_show").val(
          $(this).datepicker('getFormattedDate')
          );
      });

      function available(date) {
        dmy = date.getDate() + "-" + (date.getMonth()+1) + "-" + date.getFullYear();
        if ($.inArray(dmy, availableDates) != -1) {
          return { enabled: true, classes: "available" }
        } else {
          return { enabled: false, classes: "booked" }
        }
      }
    });
  </script>
<% end %>





